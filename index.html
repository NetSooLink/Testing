<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Main Regional - Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="database.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            background-color: #121212;
            color: #fff;
            font-family: Arial, sans-serif;
        }

        .chat-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-header {
            background-color: #1f1f1f;
            padding: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid #333;
            flex-shrink: 0;
        }

        .chat-body {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-body::-webkit-scrollbar {
            width: 8px;
        }

        .chat-body::-webkit-scrollbar-track {
            background: #1f1f1f;
        }

        .chat-body::-webkit-scrollbar-thumb {
            background-color: #444;
            border-radius: 4px;
        }

        .sender-name {
            font-size: 0.75rem;
            font-weight: bold;
            color: #555;
            margin-bottom: 4px;
        }
        .sender-location {
            font-size: 0.75rem;
            font-weight: bold;
            color: #0d6efd;
            margin-bottom: 4px;
            cursor: pointer;
        }

        .message {
            max-width: 75%;
            padding: 10px 15px;
            border-radius: 15px;
            word-wrap: break-word;
            position: relative;
        }

        .by-me {
            align-self: flex-end;
            background-color: #0d6efd;
            color: white;
            border-bottom-right-radius: 0;
        }

        .by-others {
            align-self: flex-start;
            background-color: #2c2c2c;
            color: #ddd;
            border-bottom-left-radius: 0;
        }
        .accident-message {
            background-color: #dc3545 !important;
            color: white !important;
            border-bottom-right-radius: 0 !important;
            border-bottom-left-radius: 0 !important;
            animation: pulseGlow 1.5s infinite;
        }

        .timestamp {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 3px;
            display: block;
            text-align: right;
        }

        .chat-footer {
            display: flex;
            border-top: 1px solid #333;
            background-color: #1f1f1f;
            padding: 10px;
            flex-shrink: 0;
        }

        .chat-footer input {
            background-color: #2c2c2c;
            border: none;
            color: white;
        }

        .chat-footer input:focus {
            background-color: #2c2c2c;
            color: white;
            box-shadow: none;
        }

        .chat-footer button {
            margin-left: 10px;
        }

        #emergencyBtn {
            background-color: #dc3545;
            border: none;
            margin-right: 10px;
        }

        .card-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        @keyframes pulseGlow {
            0% {
                box-shadow: 0 0 5px #ff4d4d, 0 0 10px #ff4d4d;
            }
            50% {
                box-shadow: 0 0 20px #ff4d4d, 0 0 30px #ff4d4d;
            }
            100% {
                box-shadow: 0 0 5px #ff4d4d, 0 0 10px #ff4d4d;
            }
        }
    </style>
</head>
<body>

<div class="chat-wrapper">
    <div class="chat-header">
        Main Regional
    </div>
    <div class="chat-body" id="chatBody">
        <!-- Messages will be loaded here -->
    </div>
    <div class="chat-footer">
        <button id="emergencyBtn" class="btn btn-danger">
            üö®
        </button>
        <input type="text" id="messageInput" class="form-control" placeholder="Type your message...">
        <button class="btn btn-primary" id="sendBtn">Send</button>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="accidentModal" tabindex="-1" aria-labelledby="accidentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title" id="accidentModalLabel">Accidents</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body d-flex flex-wrap gap-3 justify-content-center">
                <!-- Cards -->
                <div class="card text-white bg-warning" style="width: 12rem; cursor: pointer;" onclick="handleAccident(1,`Road accident has been reported`)">
                    <div class="card-body text-center">
                        <div class="card-icon">üöó</div>
                        <h6 class="card-title">Road Accident</h6>
                    </div>
                </div>
                <div class="card text-white bg-danger" style="width: 12rem; cursor: pointer;" onclick="handleAccident(2,`Fire breakout has been reported`)">
                    <div class="card-body text-center">
                        <div class="card-icon">üî•</div>
                        <h6 class="card-title">Fire Breakout</h6>
                    </div>
                </div>
                <div class="card text-white bg-success" style="width: 12rem; cursor: pointer;" onclick="handleAccident(3,`Elephant outbreak has been reported`)">
                    <div class="card-body text-center">
                        <div class="card-icon">üêò</div>
                        <h6 class="card-title">Elephant Outbreak</h6>
                    </div>
                </div>
                <div class="card text-white bg-secondary" style="width: 12rem; cursor: pointer;" onclick="handleAccident(4,`Terrorist activity has been reported`)">
                    <div class="card-body text-center">
                        <div class="card-icon">üí£</div>
                        <h6 class="card-title">Terrorist Activities</h6>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const emergencyBtn = document.getElementById("emergencyBtn");
    const accidentModal = new bootstrap.Modal(document.getElementById("accidentModal"));

    emergencyBtn.addEventListener("click", () => {
        accidentModal.show();
    });

    async function handleAccident(type,description) {
        if (confirm(`Are you sure you want to report: ${type}?`)) {

            await db.run(`INSERT INTO "CHAT" (user_id, data, lat, long,type) VALUES (${currentUser}, '{"content": "${description}"}', ${lat}, ${long},${type})`);

            accidentModal.hide();
        }
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const currentUser = parseInt(prompt("Enter user ID")); // Change this to your username
    const chatBody = document.getElementById('chatBody');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const SUPABASE_URL = "https://stnfjczuyfirpowepxta.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN0bmZqY3p1eWZpcnBvd2VweHRhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NzEyNjYsImV4cCI6MjA3MzM0NzI2Nn0.Qq9BArmjO0TolX0cU-dCUFBX6kibYYtEi0ge9rwYZ1U";
    var db = new SupabaseSQL(SUPABASE_URL, SUPABASE_KEY);

    // Example messages array
    let messages = [
        {user: "Bot", text: "Hello! Welcome to Main Regional chat.", time: "19:45", user_id: "0"},

    ];

    async function renderMessages() {
        await loadMessages();
        setTimeout(viewMessages, 100);

    }

    var long = 0;
    var lat = 0;
    function refreshLocation() {
        navigator.geolocation.getCurrentPosition(function (pos) {
            lat = pos.coords.latitude;
            long = pos.coords.longitude;
            console.log("Updated location:", lat, long);
        }, function (error) {
            console.error("Geolocation error:", error);
        }, {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        });
        renderMessages();
    }
    setInterval(refreshLocation, 15000); // Update location every 30 seconds
    refreshLocation(); // Initial call

    function viewMessages() {
        chatBody.innerHTML = "";
        console.log("Rendering messages:", messages);

        messages.forEach(msg => {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message');
            if(msg.type === 1 || msg.type === 2 || msg.type === 3 || msg.type === 4){
                msgDiv.classList.add('accident-message');
                sendNotification("Accident Reported", msg.text);
            }else {
                msgDiv.classList.add(msg.user_id === currentUser ? 'by-me' : 'by-others');

            }
            const distance = Math.sqrt(Math.pow((lat - msg.lat), 2) + Math.pow((long - msg.long), 2)) * 111; // Rough estimate in km
            const distanceMsg = " (" + distance.toFixed(1) + " km away)";
            msgDiv.innerHTML = `
      <div class="sender-name" onclick="viewSentLocation(${msg.lat},${msg.long})">${msg.user} ${distanceMsg}</div>
      <div class="message-text">${msg.text}</div>
      <span class="timestamp">${msg.time}</span>

    `;

            chatBody.appendChild(msgDiv);
        });

        chatBody.scrollTop = chatBody.scrollHeight;
    }
    function sendNotification(title, body) {
        // Step 1: Check permission
        if (Notification.permission === "granted") {
            new Notification(title, { body });
        } else if (Notification.permission !== "denied") {
            // Step 2: Ask for permission
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    new Notification(title, { body });
                }
            });
        }
    }
function viewSentLocation(lat, long) {
        const url = `https://www.google.com/maps?q=${lat},${long}`;
        window.open(url, '_blank');
    }
    function getCurrentTime() {
        const now = new Date();
        return now.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    }

    sendBtn.addEventListener('click', async () => {
        if (!messageInput.value.trim()) return;
        var msgText = messageInput.value.trim();
        messageInput.value = '';
        messages.push({user: "You", text: "....", time: getCurrentTime(), user_id: currentUser});
        viewMessages();
        await db.run(`INSERT INTO "CHAT" (user_id, data, lat, long) VALUES (${currentUser}, '{"content": "${msgText}"}', ${lat}, ${long})`);

        setTimeout(function (){
            renderMessages();
        }, 2000);
    });

    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendBtn.click();
        }
    });

    async function loadMessages() {
        try {
                const query = generateBoundingBoxQuery(lat, long, 5);
                console.log("Generated SQL:", query);

                const res = await db.run(query);
                console.log("Query result:", res);
                let fetchedData = res.data;
                messages = []; // Clear existing messages
                for(let entry of fetchedData) {
                    const user = entry.name || "Unknown";
                    const timestamp = formatChatTime(entry.datetimez);
                    const msg = entry.data.content || 'NULL';
                    const user_id = entry.user_id || '0';
                    const type = entry.type || 0;
                    const lat = entry.lat || 0;
                    const long = entry.long || 0;
                    messages.push({user: user, text: msg, time: timestamp, user_id: user_id, type: type, lat: lat, long: long});
                }
                console.log(res.data[0]);

        } catch (e) {
            console.error("Unexpected error:", e);
        }
    }

    function formatChatTime(utcString) {
        const utcDate = new Date(utcString);
        const offsetMillis = 5.5 * 60 * 60 * 1000; // Sri Lanka offset
        const localDate = new Date(utcDate.getTime() + offsetMillis);

        const now = new Date(Date.now() + offsetMillis);

        const localDay = localDate.getDate();
        const localMonth = localDate.getMonth();
        const localYear = localDate.getFullYear();

        const nowDay = now.getDate();
        const nowMonth = now.getMonth();
        const nowYear = now.getFullYear();

        const hh = localDate.getHours().toString().padStart(2, '0');
        const mm = localDate.getMinutes().toString().padStart(2, '0');

        const isToday = localDay === nowDay && localMonth === nowMonth && localYear === nowYear;
        const isYesterday = localDay === nowDay - 1 && localMonth === nowMonth && localYear === nowYear;

        if (isToday) return `Today at ${hh}:${mm}`;
        if (isYesterday) return `Yesterday at ${hh}:${mm}`;
        return ''; // or null if you want to skip older messages
    }

    function generateBoundingBoxQuery(lat, long, rangeKm = 5) {
        const latRange = rangeKm / 111; // ~111 km per degree latitude
        const lonRange = rangeKm / (111 * Math.cos(lat * Math.PI / 180)); // adjust for latitude

        const latMin = lat - latRange;
        const latMax = lat + latRange;
        const lonMin = long - lonRange;
        const lonMax = long + lonRange;

        return `SELECT * FROM "CHAT" JOIN "USER" ON "USER".id = "CHAT".user_id WHERE "CHAT".lat BETWEEN ${latMin.toFixed(6)} AND ${latMax.toFixed(6)} AND "CHAT".long BETWEEN ${lonMin.toFixed(6)} AND ${lonMax.toFixed(6)}`.trim();
    }

    document.addEventListener("DOMContentLoaded", async () => {
        // Initial render
        setTimeout(() => {
          refreshLocation();
        }, 100);


    });
</script>

</body>
</html>
